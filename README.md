# CLIP-based Chest X-ray Diagnosis

## 项目结构

```
.
├── config.py              # 配置文件，包含数据路径、模型参数、训练参数等配置
├── disease_analysis.py    # 疾病分析模块，处理疾病分布、共现关系和零样本预测
├── prepare_data.py        # 数据预处理模块，处理多标签数据和图像转换
├── train.py               # 训练模块，包含模型定义、损失函数和训练循环
├── visualization.py       # 可视化模块，用于绘制训练曲线和结果可视化
├── run.py                 # 主运行脚本，协调整个训练和评估流程
│
├── data/                  # 数据目录
│   ├── indiana_reports.csv     # 诊断报告数据（包含多标签诊断，以分号分隔）
│   ├── indiana_projections.csv # 投影数据（包含图像文件名）
│   ├── train_data.csv          # 处理后的训练数据
│   ├── val_data.csv            # 处理后的验证数据
│   └── images_normalized/      # 归一化后的X光图像
│
├── logs/                  # 输出目录
│   ├── training.log              # 训练日志
│   ├── training_history.png      # 训练损失曲线
│   ├── disease_distribution.png  # 疾病分布可视化
│   ├── metrics_comparison.png    # 评估指标对比
│   ├── evaluation_metrics.csv    # 评估指标数据
│   └── classification_report.csv # 详细分类报告
│
└── checkpoints/           # 模型检查点目录
    ├── checkpoint.pth     # 最新模型检查点
    └── model_best.pth     # 最佳模型检查点
```

## 文件说明

### 核心文件
- `config.py`: 配置文件
  - 数据路径配置：训练数据、验证数据和图像路径
  - 模型参数：图像编码器、文本编码器、共享嵌入空间维度等
  - 训练参数：批量大小、学习率、早停策略等
  - 日志和检查点配置

- `prepare_data.py`: 数据预处理
  - 完整多标签处理：保留所有分号分隔的疾病诊断
  - 多热编码向量转换：将文本标签转为二进制向量
  - 图像预处理：调整大小、归一化和数据增强
  - 构建和管理数据集和数据加载器

- `disease_analysis.py`: 疾病分析和零样本预测
  - 疾病分布统计：分析疾病频率和主要/次要诊断比例
  - 疾病共现分析：计算疾病间共现矩阵
  - 富文本提示生成：为每种疾病创建多样化描述模板
  - 零样本预测：基于图像特征和文本提示的预测
  - 多标签评估：计算准确率、macro_f1、micro_f1等指标

- `train.py`: 模型训练
  - 模型架构：
    - 图像编码器：ResNet50（预训练）
    - 文本编码器：Bio_ClinicalBERT（医学领域预训练）
    - 投影层：带有残差连接和Layer Normalization的非线性映射
  - 损失函数：
    - 多标签对比损失：处理一个图像对应多个标签的情况
    - 特征规范化：防止数值不稳定性
  - 训练和验证循环：
    - 学习率调度：余弦退火策略
    - 早停机制：防止过拟合
    - 检查点保存：保存最佳模型

- `visualization.py`: 可视化
  - 训练历史曲线：绘制训练和验证损失
  - 疾病分布可视化：展示疾病频率分布
  - 预测结果可视化：展示模型预测和真实标签

- `run.py`: 主程序
  - 数据加载和预处理：加载和准备数据
  - 模型训练：训练CLIP模型
  - 零样本预测：使用训练好的模型进行预测
  - 结果评估和保存：计算并保存评估指标

### 主要改进

1. **多标签处理**：
   - 完整处理所有分号分隔的疾病诊断，不再只取第一个疾病
   - 使用多热编码向量表示多个标签
   - 专门的多标签对比损失函数

2. **低频疾病增强**：
   - 分析疾病分布，识别罕见疾病
   - 为不同频率的疾病创建定制的提示模板
   - 通过多样化描述增强低频疾病的表示

3. **评估方法**：
   - 综合评估指标：准确率、macro_f1、micro_f1、weighted_f1
   - 特别关注macro_f1，给予罕见疾病同等权重
   - 详细的分类报告，包含每个疾病的精确率、召回率和F1分数

4. **代码稳健性**：
   - 完善的错误处理和异常捕获
   - 详细的日志记录，便于调试和分析
   - 更灵活的配置系统

### 数据文件
- `indiana_reports.csv`: 包含病人诊断报告的数据文件
  - 多标签诊断（以分号分隔）
  - 报告文本
  - 图像路径

- `indiana_projections.csv`: 包含X光投影信息的数据文件
- `images/images_normalized/`: 存放预处理后的X光图像

### 输出目录
- `models/`: 保存训练过程中的模型检查点
- `logs/`: 存放训练过程的日志文件
- `evaluation_plots/`: 保存评估结果的可视化图表

## 未来改进方向

经过初步训练（1个epoch），模型显示了积极的训练趋势（训练loss从0.8388降至0.6236），但在多标签预测任务上表现仍有提升空间（accuracy: 0.0000，micro F1: 0.1622）。以下是几个可能的改进方向：

### 1. 训练策略优化
- **增加训练轮次**：从当前的1个epoch增加到20-30个epoch，让模型充分学习
- **学习率调整**：使用更小的初始学习率（如5e-5）并尝试不同的学习率调度策略
- **批量大小实验**：尝试不同的批量大小（16, 32, 64）以找到最佳平衡点

### 2. 模型架构增强
- **医学专用图像编码器**：替换当前的通用ResNet50为医学领域预训练模型
  ```python
  # 潜在替代方案
  # CheXpert预训练模型
  # MedicalVIT
  # DenseNet-121 (CheXNet)
  ```
- **跨模态注意力机制**：在特征比较前添加注意力层实现图像-文本特征交互
  ```python
  # 建议添加如下模块
  class CrossModalAttention(nn.Module):
      # 实现图像特征对文本特征的注意力计算
      # 或双向注意力机制
  ```

### 3. 预测优化
- **动态阈值调整**：替换固定阈值0.5为动态或疾病特定阈值
- **集成学习**：结合多个模型预测或不同训练检查点的预测结果
- **逐层微调**：对模型不同组件采用差异化的学习率策略

### 4. 数据增强
- **更多数据**：引入额外医学数据集增加训练样本
- **高级图像增强**：应用对比度增强、旋转等特定于X光图像的增强技术
- **描述变体扩充**：继续丰富疾病描述模板，尤其是罕见疾病



